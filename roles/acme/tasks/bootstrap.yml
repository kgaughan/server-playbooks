---
- name: check if we need to bootstrap {{ item.key }}
  stat:
    path: "{{ webserver_config }}/vhosts/{{ item.key }}"
  register: vhost

- name: bootstrap {{ item.key }}
  block:
    - name: deploy temporary vhost
      template:
        src: vhost.j2
        dest: "{{ webserver_config }}/vhosts/{{ item.key }}"

    - name: reload nginx
      service:
        name: nginx
        state: reloaded

    # This can fail for some weird reason. I'm not sure, but this needs
    # investigation.
    - name: generate missing certificates
      command: "{{ acme_client_root }}/acme-client.sh"
      ignore_errors: true

  when: not vhost.stat.exists
