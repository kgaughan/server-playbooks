---
- name: install packages
  pkgng:
    name:
      - python3
      - py36-bjoern
      - py36-python-pam
      - py36-WsgiDAV
    cached: true

- name: ensure the tools directory exists
  file:
    name: "{{ tools_root }}"
    state: directory
    mode: 0755

- name: ensure the socket directory exists
  file:
    name: "{{ dav_app_sock | dirname }}"
    state: directory
    mode: 0755

- name: ensure the DAV root directory exists
  file:
    name: "{{ dav_root }}"
    state: directory
    owner: www
    group: www
    mode: 0755

- name: copy up the app
  copy:
    src: dav.py
    dest: "{{ tools_root }}"
  notify:
    - reload supervisor

- name: deploy supervisor configuration
  template:
    src: dav.ini.j2
    dest: "/usr/local/etc/supervisord.d/dav.ini"
  notify:
    - reload supervisor

- name: deploy vhost
  template:
    src: vhost.j2
    dest: "{{ webserver_config }}/vhosts/{{ dav_site }}"
  notify:
    - reload nginx
