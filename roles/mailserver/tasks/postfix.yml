---
- name: install packages
  pkgng:
    name: '{{ item }}'
    cached: yes
  with_items:
    - postfix
    - sqlite3

- name: ensure the postfix configuration root exists
  file:
    dest: "{{ postfix_root }}"
    state: directory

- name: deploy master.cf
  copy:
    src: master.cf
    dest: "{{ postfix_root }}"
    mode: 0644
  notify:
    - restart postfix

- name: deploy main.cf
  template:
    src: main.cf.j2
    dest: "{{ postfix_root }}/main.cf"
    mode: 0644
  notify:
    - restart postfix

- name: copy database schema up using temporary jankballs method
  copy:
    src: virtual.sql
    dest: "/tmp/"
  register: dbschema

- name: initialise virtual mailbox database
  command: sqlite3 -init {{ dbschema.path }} {{ vbox_db_path }} creates={{ vbox_db_path }}

- name: copy up mapping config
  template:
    src: "{{ item }}"
    dest: "{{ postfix_root }}/{{ item | basename | splitext | first }}"
  with_fileglob: "templates/virtual-mailbox-*.cf.j2"

- name: start postfix
  service:
    name: postfix
    enabled: yes
    state: started
