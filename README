===================
My Server Playbooks
===================

These are the Ansible playbooks I use for setting up my servers. I use FreeBSD
on them exclusively, so they may be of limited utility to people using other
OSs.

Use
===

Initial setup of a fresh machine can be done with `bootstrap.yml`. This
ensures that Python and sudo are installed on the target machine and ensures
that users in the `wheel` group don't need to provide a password when using
sudo. Run this with::

    make bootstrap

Once all hosts have been bootstrapped, you can run the rest of the main
playbooks with::

    make

This runs all the playbooks listed in `site.yml`.

Nameserver role
===============

This role just does basic setup needed for both primary and secondary
nameservers. The actual heavy lifting is in a seperate repo which contains the
zonefiles.

Buildserver role
================

To build a port (here 'mail/dovecot' in the '10amd64' jail), run::

    sudo poudriere bulk -j 10amd64 mail/dovecot

To update the ports tree::

    sudo poudriere ports -u

Hetzner
=======

manann used to become uncommunicative when Hetzner would do network
maintenance. I found https://forums.freebsd.org/threads/60675/#post-350427,
which states:

    IIRC these problems are due to buggy/crappy offloading in some (all?)
    Realtek NICs. Try disabling LRO and TSO on them. I don't think Realtek
    NICs do checksum-offloading, but you could also try to disable tx/rcsum
    (it returns an error if the driver/card doesn't support it).

To do this::

    ifconfig re0 -tso -lro

I haven't had issues since, and should probably make that a task, but haven't
thought of a nice way to do it.

Ideas for further changes
=========================

* Consider blacklistd:
  https://gioarc.me/2017/05/29/blacklistd-a-new-approach-to-blocking-attackers/
* SSHFP:
  http://jpmens.net/2012/11/03/an-action-plugin-for-ansible-to-handle-ssh-host-keys/

To do
=====

Configure:

* OAuth server.

Nice to have:

* Secondary MX

.. vim:set ft=rst:
